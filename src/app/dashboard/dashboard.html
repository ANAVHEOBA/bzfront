<div class="dashboard-layout">
  <div class="dashboard-container">
    <header class="dashboard-header">
      <h1>Campaign Dashboard</h1>
      <div class="header-actions">
        <a routerLink="/analytics" class="btn btn-secondary">Analytics</a>
        <button (click)="logout()" class="btn btn-logout">Logout</button>
      </div>
    </header>

    @if (uploadSuccess) {
      <div class="notification success">Campaign uploaded successfully!</div>
    }
    @if (errorMessage) {
      <div class="notification error">{{ errorMessage }}</div>
    }

    <!-- Upload Form -->
    <div class="card upload-card">
      <h2>Create New Campaign</h2>
      <form (ngSubmit)="onSubmit()" class="upload-form">
        <div class="form-group">
          <label for="slug">Campaign Slug *</label>
          <input type="text" id="slug" [(ngModel)]="slug" name="slug" required
                 placeholder="e.g., summer-sale-2024">
        </div>

        <div class="form-group">
          <label for="waLink">WhatsApp Link *</label>
          <input type="text" id="waLink" [(ngModel)]="waLink" name="waLink" required
       placeholder="e.g., https://wa.me/1234567890 or https://earn.superteam.fun/...">
        </div>

        <div class="form-group">
          <label for="waButtonLabel">WhatsApp Button Text *</label>
          <input type="text" id="waButtonLabel" [(ngModel)]="waButtonLabel"
                 name="waButtonLabel" required placeholder="e.g., Order on WhatsApp">
        </div>

        <div class="form-group">
          <label for="caption">Caption *</label>
          <textarea id="caption" [(ngModel)]="caption" name="caption" required
                    rows="3" placeholder="Enter campaign description..."></textarea>
        </div>

        <div class="form-group">
          <label for="tags">Tags</label>
          <input type="text" id="tags" [(ngModel)]="tagsInput" name="tags"
                 placeholder="e.g., promo, sale, summer (comma-separated)">
        </div>

        <!-- Popup Timing -->
        <div class="form-group">
          <label for="popupTriggerType">Popup Trigger</label>
          <select id="popupTriggerType" [(ngModel)]="popupTriggerType" name="popupTriggerType">
            <option [ngValue]="null">— None —</option>
            <option value="seconds">After seconds</option>
            <option value="percent">At % of video</option>
          </select>
        </div>

        @if (popupTriggerType) {
          <div class="form-group">
            <label for="popupTriggerValue">
              {{ popupTriggerType === 'seconds' ? 'Seconds' : 'Percent (0-100)' }}
            </label>
            <input type="number" id="popupTriggerValue"
                   [(ngModel)]="popupTriggerValue" name="popupTriggerValue"
                   min="0"
                   [max]="popupTriggerType === 'percent' ? 100 : 9999"
                   placeholder="e.g., 8">
          </div>
        }

        <!-- File Upload -->
        <div class="file-upload">
          <label>Full Resolution Image / Video *</label>
          <input type="file" accept="image/*,video/*"
                 (change)="onFileSelected($event)" [disabled]="isUploading">
          <span class="file-name">{{ fullFile?.name || 'No file selected' }}</span>
          @if (fullUrl) {
            <div class="image-preview">
              <img [src]="fullUrl" alt="Full">
            </div>
          }
        </div>

        <button type="submit" class="btn btn-primary" [disabled]="isUploading">
          @if (isUploading) {
            <span class="spinner"></span> Uploading...
          } @else {
            Upload Campaign
          }
        </button>
      </form>
    </div>

    <!-- Recent Campaigns -->
    <div class="card">
      <h2>Recent Campaigns</h2>
      @if (campaigns.length) {
        <div class="campaign-grid">
          @for (c of campaigns; track c.slug) {
            <div class="campaign-item">
              <a [routerLink]="['/campaigns', c.slug]">
                <img [src]="c.fullThumbnailUrl" [alt]="c.slug" loading="lazy" />
              </a>
              <p>{{ c.slug }}</p>

              <!-- Actions -->
              <div class="campaign-actions">
                <button class="btn btn-share" (click)="openShareLinks(c.slug)">Share</button>
                <button class="btn btn-secondary" (click)="openEdit(c)">Edit</button>
                <button class="btn btn-danger" (click)="deleteCampaign(c.slug)">Delete</button>
              </div>

              <!-- Inline Edit Panel -->
              @if (editingSlug === c.slug) {
                <div class="edit-panel">
                  <h4>Edit {{ c.slug }}</h4>

                  <label>Slug</label>
                  <input [(ngModel)]="editForm.slug" name="editSlug" />

                  <label>Caption</label>
                  <textarea [(ngModel)]="editForm.caption" rows="2"></textarea>

                  <label>WhatsApp Link</label>
                  <input [(ngModel)]="editForm.waLink" name="editWaLink" />

                  <label>WhatsApp Button Text</label>
                  <input [(ngModel)]="editForm.waButtonLabel" />

                  <label>Tags</label>
                  <input [(ngModel)]="editForm.tagsInput" name="editTags"
                         placeholder="e.g., promo, sale, summer (comma-separated)" />

                  <label>Popup Trigger</label>
                  <select [(ngModel)]="editForm.popupTriggerType">
                    <option [ngValue]="null">None</option>
                    <option value="seconds">Seconds</option>
                    <option value="percent">Percent</option>
                  </select>

                  @if (editForm.popupTriggerType) {
                    <label>Value</label>
                    <input type="number" [(ngModel)]="editForm.popupTriggerValue" />
                  }

                  <label>
                    Replace Full File
                    <input type="file" accept="image/*,video/*"
                           (change)="onEditFile($event)" />
                  </label>

                  <div class="edit-actions">
                    <button class="btn btn-primary" [disabled]="isSaving"
                            (click)="saveEdit()">
                      {{ isSaving ? 'Saving...' : 'Save' }}
                    </button>
                    <button class="btn btn-outline" (click)="cancelEdit()">Cancel</button>
                  </div>

                  @if (editError) {
                    <div class="notification error">{{ editError }}</div>
                  }
                </div>
              }
            </div>
          }
        </div>
      } @else {
        <p class="empty-state">No campaigns uploaded yet</p>
      }
    </div>

    <!-- Share Links Modal -->
    @if (shareLinksData || shareLinksLoading) {
      <div class="modal-overlay" (click)="closeShareLinks()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <button class="modal-close" (click)="closeShareLinks()">&times;</button>

          @if (shareLinksLoading) {
            <div class="loading">Loading share links...</div>
          }

          @if (shareLinksError) {
            <div class="notification error">{{ shareLinksError }}</div>
          }

          @if (shareLinksData && !shareLinksLoading) {
            <h2>Share: {{ shareLinksData.campaignSlug }}</h2>

            <div class="share-links-list">
              @for (platform of shareLinksData.platforms; track platform.name) {
                <div class="share-link-item">
                  <span class="platform-label">{{ platform.label }}</span>
                  <div class="link-row">
                    <input type="text" [value]="platform.url" readonly />
                    <button class="btn btn-copy" (click)="copyLink(platform.url)">Copy</button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>