<div class="dashboard-layout">
  <div class="dashboard-container">
    <header class="dashboard-header">
      <h1>Campaign Dashboard</h1>
      <button (click)="logout()" class="btn btn-logout">Logout</button>
    </header>

    @if (uploadSuccess) {
      <div class="notification success">Campaign uploaded successfully!</div>
    }
    @if (errorMessage) {
      <div class="notification error">{{ errorMessage }}</div>
    }

    <!-- Upload Form -->
    <div class="card upload-card">
      <h2>Create New Campaign</h2>
      <form (ngSubmit)="onSubmit()" class="upload-form">
        <div class="form-group">
          <label for="slug">Campaign Slug *</label>
          <input type="text" id="slug" [(ngModel)]="slug" name="slug" required
                 placeholder="e.g., summer-sale-2024">
        </div>

        <div class="form-group">
          <label for="waLink">WhatsApp Link *</label>
          <input type="url" id="waLink" [(ngModel)]="waLink" name="waLink" required
                 placeholder="https://wa.me/1234567890">
        </div>

        <div class="form-group">
          <label for="waButtonLabel">WhatsApp Button Text *</label>
          <input type="text" id="waButtonLabel" [(ngModel)]="waButtonLabel"
                 name="waButtonLabel" required placeholder="e.g., Order on WhatsApp">
        </div>

        <div class="form-group">
          <label for="caption">Caption *</label>
          <textarea id="caption" [(ngModel)]="caption" name="caption" required
                    rows="3" placeholder="Enter campaign description..."></textarea>
        </div>

        <!-- Popup Timing -->
        <div class="form-group">
          <label for="popupTriggerType">Popup Trigger</label>
          <select id="popupTriggerType" [(ngModel)]="popupTriggerType" name="popupTriggerType">
            <option [ngValue]="null">â€” None â€”</option>
            <option value="seconds">After seconds</option>
            <option value="percent">At % of video</option>
          </select>
        </div>

        @if (popupTriggerType) {
          <div class="form-group">
            <label for="popupTriggerValue">
              {{ popupTriggerType === 'seconds' ? 'Seconds' : 'Percent (0-100)' }}
            </label>
            <input type="number" id="popupTriggerValue"
                   [(ngModel)]="popupTriggerValue" name="popupTriggerValue"
                   min="0"
                   [max]="popupTriggerType === 'percent' ? 100 : 9999"
                   placeholder="e.g., 8">
          </div>
        }

        <!-- File Uploads -->
        <div class="file-upload-group">
          <div class="file-upload">
            <label>Full Resolution Image / Video *</label>
            <input type="file" accept="image/*,video/*"
                   (change)="onFileSelected($event, 'full')" [disabled]="isUploadingWithProgress">
            <span class="file-name">{{ fullFile?.name || 'No file selected' }}</span>
            @if (fullUrl) {
              <div class="image-preview">
                <img [src]="fullUrl" alt="Full">
              </div>
            }
          </div>
        </div>

        <!-- Progress Tracking -->
        @if (isUploadingWithProgress) {
          <div class="upload-progress">
            <div class="progress-info">
              <span>ðŸ“¤ Uploading... {{ uploadProgress }}%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="uploadProgress"></div>
            </div>
          </div>
        }

        <button type="submit" class="btn btn-primary" [disabled]="isUploadingWithProgress">
          @if (isUploadingWithProgress) {
            <span class="spinner"></span> Uploading... {{ uploadProgress }}%
          } @else {
            Upload Campaign
          }
        </button>

        <!-- Alternative XHR Upload Button -->
        <button type="button" class="btn btn-secondary" (click)="onSubmitXHR()" [disabled]="isUploadingWithProgress">
          @if (isUploadingWithProgress) {
            <span class="spinner"></span> Uploading... {{ uploadProgress }}%
          } @else {
            Upload (XHR Method)
          }
        </button>
      </form>
    </div>

    <!-- Recent Campaigns -->
    <div class="card">
      <h2>Recent Campaigns</h2>
      @if (campaigns.length) {
        <div class="campaign-grid">
          @for (c of campaigns; track c.slug) {
            <div class="campaign-item">
              <a [routerLink]="['/campaigns', c.slug]">
                <img [src]="c.fullThumbnailUrl" [alt]="c.slug" loading="lazy" />
              </a>
              <p>{{ c.slug }}</p>

              <button class="btn btn-danger" (click)="deleteCampaign(c.slug)">Delete</button>
              <button class="btn btn-secondary" (click)="openEdit(c)">Edit</button>

              <!-- Inline Edit Panel -->
              @if (editingSlug === c.slug) {
                <div class="edit-panel">
                  <h4>Edit {{ c.slug }}</h4>

                  <label>Slug</label>
                  <input [(ngModel)]="editForm.slug" name="editSlug" />

                  <label>Caption</label>
                  <textarea [(ngModel)]="editForm.caption" rows="2"></textarea>

                  <label>WhatsApp Link</label>
                  <input [(ngModel)]="editForm.waLink" name="editWaLink" />

                  <label>WhatsApp Button Text</label>
                  <input [(ngModel)]="editForm.waButtonLabel" />

                  <label>Popup Trigger</label>
                  <select [(ngModel)]="editForm.popupTriggerType">
                    <option [ngValue]="null">None</option>
                    <option value="seconds">Seconds</option>
                    <option value="percent">Percent</option>
                  </select>

                  @if (editForm.popupTriggerType) {
                    <label>Value</label>
                    <input type="number" [(ngModel)]="editForm.popupTriggerValue" />
                  }

                  <label>
                    Replace Full
                    <input type="file" accept="image/*,video/*"
                           (change)="onEditFile($event, 'full')" />
                  </label>

                  <div class="edit-actions">
                    <button class="btn btn-primary" [disabled]="isSaving"
                            (click)="saveEdit()">
                      {{ isSaving ? 'Saving...' : 'Save' }}
                    </button>
                    <button class="btn btn-outline" (click)="cancelEdit()">Cancel</button>
                  </div>

                  @if (editError) {
                    <div class="notification error">{{ editError }}</div>
                  }
                </div>
              }
            </div>
          }
        </div>
      } @else {
        <p class="empty-state">No campaigns uploaded yet</p>
      }
    </div>
  </div>
</div>